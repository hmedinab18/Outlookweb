<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NetCom (Red Comercial)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--brand1:#0057FF;--brand2:#00A7E1;--accent:#FF6A00}
    html,body{font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .brand-grad{background: linear-gradient(135deg,var(--brand1),var(--brand2));}
    .card{background:white;border-radius:1rem;box-shadow:0 10px 25px rgba(2,6,23,0.08)}
    .pill{border-radius:9999px;padding:.25rem .75rem;font-weight:600}
    .btn-primary{background:#FF6A00;color:#fff}
    .btn-primary:hover{background:#e45f00}
    .btn-sec{background:#1d4ed8;color:#fff}
    .btn-sec:hover{background:#1e40af}
    .th{white-space:nowrap}
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- Topbar -->
  <header class="brand-grad text-white">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-bold">NetCom — Julito me llegas al chompi</h1>
      <div class="flex items-center gap-3">
        <span id="userBadge" class="hidden text-sm bg-white/20 px-3 py-1 rounded-full"></span>
        <button id="btnLogout" class="hidden text-sm font-semibold bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg">Salir</button>
      </div>
    </div>
  </header>

  <!-- Auth -->
  <section id="auth" class="max-w-6xl mx-auto px-4 mt-10">
    <div class="grid md:grid-cols-2 gap-6 items-center">
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-2">Iniciar sesión</h2>
        <form id="loginForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium">Usuario</label>
            <input id="username" class="w-full mt-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="vendedor / gestor / gerente / admin" required />
          </div>
          <div>
            <label class="block text-sm font-medium">Contraseña</label>
            <input id="password" type="password" class="w-full mt-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="123456" required />
          </div>
          <button class="w-full btn-primary text-white font-semibold px-4 py-2 rounded-lg">Entrar</button>
        </form>
      </div>
      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-2">Roles de prueba</h2>
        <ul class="list-disc ml-5 text-sm space-y-1 text-slate-700">
          <li><b>vendedor</b> / 123456</li>
          <li><b>gestor</b> / 123456</li>
          <li><b>gerente</b> / 123456</li>
          <li><b>admin</b> / 123456</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- App -->
  <main id="app" class="hidden max-w-6xl mx-auto px-4 mt-8">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button data-tab="ventas" class="tab px-4 py-2 rounded-xl bg-white shadow text-slate-700 font-semibold">Mis Ventas</button>
      <button data-tab="nueva" class="tab px-4 py-2 rounded-xl bg-white shadow text-slate-700 font-semibold">Nueva Venta</button>
      <button data-tab="gestion" class="tab px-4 py-2 rounded-xl bg-white shadow text-slate-700 font-semibold hidden">Registro de Ventas (Gestor)</button>
      <button data-tab="reporte" class="tab px-4 py-2 rounded-xl bg-white shadow text-slate-700 font-semibold hidden">Reporte & Avance</button>
      <button data-tab="dashboard" class="tab px-4 py-2 rounded-xl bg-white shadow text-slate-700 font-semibold hidden">Dashboard</button>
      <button data-tab="usuarios" class="tab px-4 py-2 rounded-xl bg-white shadow text-slate-700 font-semibold hidden">Usuarios</button>
      <div class="ml-auto flex gap-2">
        <button id="btnExport" class="px-3 py-2 rounded-xl btn-sec text-sm">Exportar JSON</button>
        <label class="px-3 py-2 rounded-xl bg-slate-200 text-sm cursor-pointer">Importar JSON<input id="inputImport" type="file" accept="application/json" class="hidden"/></label>
      </div>
    </div>

    <!-- Panel: Ventas -->
    <section id="panel-ventas" class="card p-4">
      <div class="flex items-center justify-between mb-3 gap-2 flex-wrap">
        <h3 class="text-lg font-semibold">Ventas</h3>
        <div class="flex items-center gap-2 ml-auto">
          <label class="text-sm text-slate-600">Estado</label>
          <select id="filterEstado" class="border rounded-lg px-3 py-1">
            <option value="">Todos</option>
            <option>Registrado</option>
            <option>En revisión</option>
            <option>Aprobado</option>
            <option>Rechazado</option>
            <option>Contrato generado</option>
          </select>
          <label class="text-sm text-slate-600">Vendedor</label>
          <select id="filterVendedor" class="border rounded-lg px-3 py-1 min-w-40">
            <option value="">Todos</option>
          </select>
          <button id="btnExportXLSX" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">Exportar Excel</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2 th">ID</th>
              <th class="text-left p-2 th">Cliente</th>
              <th class="text-left p-2 th">RUC/DNI</th>
              <th class="text-left p-2 th">Monto (S/.)</th>
              <th class="text-left p-2 th">Estado</th>
              <th class="text-left p-2 th">Vendedor</th>
              <th class="text-left p-2 th">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyVentas"></tbody>
        </table>
      </div>
    </section>

    <!-- Panel: Nueva Venta (solo vendedor) -->
    <section id="panel-nueva" class="hidden card p-4">
      <h3 class="text-lg font-semibold mb-3">Registrar nueva venta</h3>
      <form id="formVenta" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Cliente (Razón Social / Nombres)</label>
          <input id="vCliente" class="w-full mt-1 px-3 py-2 rounded-lg border" placeholder="EMPRESA XYZ SAC" required />
        </div>
        <div>
          <label class="block text-sm font-medium">RUC / DNI</label>
          <input id="vDoc" class="w-full mt-1 px-3 py-2 rounded-lg border" placeholder="2060… / 48…" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Servicio / Plan</label>
          <input id="vServicio" class="w-full mt-1 px-3 py-2 rounded-lg border" placeholder="Internet Dedicado 100 Mbps" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Monto (S/.)</label>
          <input id="vMonto" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-lg border" placeholder="1500.00" required />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">Observaciones</label>
          <textarea id="vObs" class="w-full mt-1 px-3 py-2 rounded-lg border" placeholder="Detalle adicional (opcional)"></textarea>
        </div>
        <div class="md:col-span-2 flex gap-2">
          <button class="btn-primary text-white font-semibold px-4 py-2 rounded-lg">Guardar</button>
          <button type="reset" class="bg-slate-200 px-4 py-2 rounded-lg">Limpiar</button>
        </div>
      </form>
    </section>

    <!-- Panel: Gestión (gestor/admin) -->
    <section id="panel-gestion" class="hidden card p-4">
      <h3 class="text-lg font-semibold mb-3">Registro de Ventas (Formato Entel – Fila 1)</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full text-[12px]">
          <thead id="theadGestion" class="bg-slate-100"></thead>
          <tbody id="tbodyGestion"></tbody>
        </table>
      </div>
      <p class="text-[11px] text-slate-500 mt-2">*Algunos campos están bloqueados para mantener consistencia con la plantilla.</p>
    </section>

    <!-- Panel: Reporte (gerente/admin) -->
    <section id="panel-reporte" class="hidden card p-4">
      <h3 class="text-lg font-semibold mb-3">Reporte & Avance de Ventas</h3>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="p-4 rounded-xl bg-white border">
          <p class="text-xs text-slate-500">Total Monto (S/.)</p>
          <p id="kpiMonto" class="text-2xl font-bold">0.00</p>
        </div>
        <div class="p-4 rounded-xl bg-white border">
          <p class="text-xs text-slate-500">Ventas Totales</p>
          <p id="kpiVentas" class="text-2xl font-bold">0</p>
        </div>
        <div class="p-4 rounded-xl bg-white border">
          <p class="text-xs text-slate-500">Conversión a Contrato</p>
          <p class="text-2xl font-bold"><span id="kpiConv">0</span>%</p>
          <div class="mt-2 w-full h-2 bg-slate-200 rounded-full"><div id="barConv" class="h-2 rounded-full" style="width:0%; background:#00A7E1"></div></div>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2">Estado</th>
              <th class="text-left p-2">#</th>
              <th class="text-left p-2">Monto (S/.)</th>
            </tr>
          </thead>
          <tbody id="tbodyResumen"></tbody>
        </table>
      </div>
    </section>

    <!-- Panel: Dashboard (gerente/admin) -->
    <section id="panel-dashboard" class="hidden card p-4">
      <h3 class="text-lg font-semibold mb-3">Dashboard</h3>
      <div class="grid md:grid-cols-4 gap-4 mb-4">
        <div class="p-4 rounded-xl bg-white border">
          <p class="text-xs text-slate-500">Ticket Promedio (S/.)</p>
          <p id="kpiTicket" class="text-2xl font-bold">0.00</p>
        </div>
        <div class="p-4 rounded-xl bg-white border">
          <p class="text-xs text-slate-500">Aprobadas</p>
          <p id="kpiAprobadas" class="text-2xl font-bold">0</p>
        </div>
        <div class="p-4 rounded-xl bg-white border">
          <p class="text-xs text-slate-500">En revisión</p>
          <p id="kpiRevision" class="text-2xl font-bold">0</p>
        </div>
        <div class="p-4 rounded-xl bg-white border">
          <p class="text-xs text-slate-500">Rechazadas</p>
          <p id="kpiRechazadas" class="text-2xl font-bold">0</p>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="p-4 rounded-xl bg-white border">
          <div class="flex items-center justify-between mb-2">
            <p class="font-semibold">Monto por Mes</p>
            <span class="text-xs text-slate-500">Suma (S/.)</span>
          </div>
          <div id="chartMeses" class="w-full overflow-x-auto"></div>
        </div>
        <div class="p-4 rounded-xl bg-white border">
          <div class="flex items-center justify-between mb-2">
            <p class="font-semibold">Monto por Estado</p>
            <span class="text-xs text-slate-500">Suma (S/.)</span>
          </div>
          <div id="chartEstados" class="w-full overflow-x-auto"></div>
        </div>
      </div>
    </section>

    <!-- Panel: Usuarios (admin) -->
    <section id="panel-usuarios" class="hidden card p-4">
      <h3 class="text-lg font-semibold mb-3">Usuarios (demo)</h3>
      <form id="formUser" class="grid md:grid-cols-4 gap-3 items-end">
        <div>
          <label class="block text-sm font-medium">Usuario</label>
          <input id="uUser" class="w-full mt-1 px-3 py-2 rounded-lg border" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Contraseña</label>
          <input id="uPass" class="w-full mt-1 px-3 py-2 rounded-lg border" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Rol</label>
          <select id="uRol" class="w-full mt-1 px-3 py-2 rounded-lg border" required>
            <option value="vendedor">vendedor</option>
            <option value="gestor">gestor</option>
            <option value="gerente">gerente</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <button class="btn-sec px-4 py-2 rounded-lg">Agregar</button>
      </form>
      <div class="overflow-x-auto mt-4">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2">Usuario</th>
              <th class="text-left p-2">Rol</th>
              <th class="text-left p-2">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyUsers"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Templates -->
  <template id="tplVentaRow">
    <tr class="border-b">
      <td class="p-2 font-mono text-xs">#ID#</td>
      <td class="p-2">#CLIENTE#</td>
      <td class="p-2">#DOC#</td>
      <td class="p-2">#MONTO#</td>
      <td class="p-2"><span class="pill bg-slate-100 text-slate-700">#ESTADO#</span></td>
      <td class="p-2">#VENDEDOR#</td>
      <td class="p-2 flex gap-2">
        <button data-action="contrato" data-id="#ID#" class="text-xs btn-primary px-3 py-1 rounded-lg">Contrato</button>
        <button data-action="ver" data-id="#ID#" class="text-xs bg-slate-200 px-3 py-1 rounded-lg">Ver</button>
        <button data-action="borrar" data-id="#ID#" class="text-xs bg-rose-600 text-white px-3 py-1 rounded-lg">Borrar</button>
      </td>
    </tr>
  </template>

  <template id="tplUserRow">
    <tr class="border-b">
      <td class="p-2 font-mono text-xs">#USER#</td>
      <td class="p-2">#ROL#</td>
      <td class="p-2">
        <button data-user="#USER#" class="btnDelUser text-xs bg-rose-600 text-white px-3 py-1 rounded-lg">Eliminar</button>
      </td>
    </tr>
  </template>

  <script>
    // ======== UTIL ========
    const LS = { get(k, d){ try{ return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(d)); }catch{ return d } }, set(k, v){ localStorage.setItem(k, JSON.stringify(v)); } }
    const fmtMoney = v => Number(v || 0).toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2})
    const nowIso = () => new Date().toISOString()
    function sanitize(s){ return (s||'').toUpperCase().replace(/\\s+/g,' ').trim() }

    // ======== DATA (seed) ========
    (function seed(){
      if(!localStorage.getItem('users')){
        LS.set('users',[
          {user:'vendedor', pass:'123456', rol:'vendedor'},
          {user:'gestor', pass:'123456', rol:'gestor'},
          {user:'gerente', pass:'123456', rol:'gerente'},
          {user:'admin', pass:'123456', rol:'admin'},
        ])
      }
      if(!localStorage.getItem('ventas')){
        const estados=['Registrado','En revisión','Aprobado','Rechazado','Contrato generado']
        const servicios=['INTERNET DEDICADO 50','INTERNET DEDICADO 100','INTERNET DEDICADO 200','ENLACE MPLS','DATA CENTER']
        const clientes=['ACME SAC','BETA SRL','OMEGA SAC','DELTA SAC','GAMMA SAC','ZENITH SAC','LAMBDA SAC','ORION SAC','ATLAS SAC','NOVA SAC','URANO SAC','KRONOS SAC','ALFA SAC','SIGMA SAC','PHOENIX SAC','VECTOR SAC','NEBULA SAC','QUANTUM SAC','TERRA SAC','AURORA SAC']
        const base = Date.now()
        const ventas = Array.from({length:20}).map((_,i)=>{
          const estado = estados[(i*3)%estados.length]
          const servicio = servicios[i%servicios.length]
          const cliente = clientes[i%clientes.length]
          const monto = [850,920,1100,1500,1750,2100,2500,1320,980,3050][i%10]
          const fecha = new Date(base - (i*5+2)*24*60*60*1000).toISOString()
          return {
            id:i+1,
            cliente,
            doc: i%2? '2060'+String(1111111+i).padStart(7,'0') : '10'+String(40000000+i).padStart(8,'0'),
            servicio,
            monto,
            estado,
            vendedor:'vendedor',
            gestor: (i%3===0? 'gestor' : ''),
            obs:'',
            fecha,
            extra:{'OPP / ID':'OPP-'+String(i+1).padStart(3,'0')}
          }
        })
        LS.set('ventas', ventas)
      }
    })();

    // Garantiza que existan siempre los cuatro usuarios demo
    function ensureDemoUsers(){
      const base=[
        {user:'vendedor', pass:'123456', rol:'vendedor'},
        {user:'gestor',   pass:'123456', rol:'gestor'},
        {user:'gerente',  pass:'123456', rol:'gerente'},
        {user:'admin',    pass:'123456', rol:'admin'},
      ]
      const users = LS.get('users', []) || []
      let changed = false
      base.forEach(b=>{ if(!users.some(u=>u.user===b.user)){ users.push(b); changed = true } })
      if(changed) LS.set('users', users)
    }
    ensureDemoUsers();

    // ======== SESSION ========
    let session = LS.get('session', null)
    const elAuth = document.getElementById('auth')
    const elApp = document.getElementById('app')
    const userBadge = document.getElementById('userBadge')
    const btnLogout = document.getElementById('btnLogout')

    function enter(){
      if(!session){ elAuth.classList.remove('hidden'); elApp.classList.add('hidden'); btnLogout.classList.add('hidden'); userBadge.classList.add('hidden'); return }
      elAuth.classList.add('hidden'); elApp.classList.remove('hidden'); btnLogout.classList.remove('hidden'); userBadge.classList.remove('hidden')
      userBadge.textContent = session.user + ' · ' + session.rol
      renderTabsForRole(); renderAll()
    }

    document.getElementById('loginForm').addEventListener('submit', e=>{
      e.preventDefault()
      const u = document.getElementById('username').value.trim()
      const p = document.getElementById('password').value.trim()
      const users = LS.get('users', [])
      const found = users.find(x=>x.user===u && x.pass===p)
      if(!found){ alert('Usuario o contraseña incorrectos'); return }
      session = {user:found.user, rol:found.rol}
      LS.set('session', session)
      enter()
    })
    btnLogout.addEventListener('click', ()=>{ LS.set('session', null); session=null; enter() })

    // ======== TABS ========
    const panels = { ventas: document.getElementById('panel-ventas'), nueva: document.getElementById('panel-nueva'), gestion: document.getElementById('panel-gestion'), reporte: document.getElementById('panel-reporte'), dashboard: document.getElementById('panel-dashboard'), usuarios: document.getElementById('panel-usuarios') }
    function showTab(name){ Object.values(panels).forEach(p=>p.classList.add('hidden')); panels[name]?.classList.remove('hidden'); }
    document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)))

    function renderTabsForRole(){
      const role = session?.rol
      const tabVentas = document.querySelector('[data-tab="ventas"]')
      const tabNueva = document.querySelector('[data-tab="nueva"]')
      const tabGestion = document.querySelector('[data-tab="gestion"]')
      const tabUsuarios = document.querySelector('[data-tab="usuarios"]')
      const tabReporte = document.querySelector('[data-tab="reporte"]')
      const tabDashboard = document.querySelector('[data-tab="dashboard"]')
      tabNueva.classList.toggle('hidden', role!=='vendedor')
      tabGestion.classList.toggle('hidden', !(role==='gestor'||role==='admin'))
      tabUsuarios.classList.toggle('hidden', role!=='admin')
      tabReporte.classList.toggle('hidden', !(role==='gerente'||role==='admin'))
      tabDashboard.classList.toggle('hidden', !(role==='gerente'||role==='admin'))
      // Gerente puede ver "Ventas" (solo lectura)
      tabVentas.classList.toggle('hidden', false)
      if(role==='gerente'){
        tabNueva.classList.add('hidden');
        tabGestion.classList.add('hidden');
        tabUsuarios.classList.add('hidden');
        showTab('ventas');
        return
      }
      showTab('ventas')
    }

    // ======== VENTAS ========
    const tbodyVentas    = document.getElementById('tbodyVentas')
    const filterEstado   = document.getElementById('filterEstado')
    const filterVendedor = document.getElementById('filterVendedor')
    const btnExportXLSX  = document.getElementById('btnExportXLSX')

    function listVentas(){ return LS.get('ventas', []) }
    function saveVentas(v){ LS.set('ventas', v) }

    function vendedoresUnicos(data){
      const set = new Set(data.map(v=> (v.vendedor||'').toString().trim()).filter(Boolean))
      return Array.from(set).sort((a,b)=>a.localeCompare(b))
    }
    function applyFilters(data){
      const est = filterEstado?.value||''
      const ven = filterVendedor?.value||''
      return data.filter(v=> (est===''||v.estado===est) && (ven===''||v.vendedor===ven))
    }
    function renderVendedorFilter(base){
      const role = session?.rol
      const pool = (role==='admin'||role==='gerente'||role==='gestor') ? base : base.filter(v=> v.vendedor===session?.user)
      const list = vendedoresUnicos(pool)
      const current = filterVendedor.value
      filterVendedor.innerHTML = '<option value="">Todos</option>' + list.map(v=>`<option ${v===current?'selected':''}>${v}</option>`).join('')
      filterVendedor.parentElement.classList.toggle('hidden', !(role==='gerente'||role==='admin'||role==='gestor'))
    }

    function renderVentas(){
      const role = session?.rol
      const user = session?.user
      const base = listVentas().filter(v=> role==='admin' || role==='gestor' || role==='gerente' || v.vendedor===user)
      renderVendedorFilter(base)
      const data = applyFilters(base)
      const rows = data.map(v=>{
        let row = document.getElementById('tplVentaRow').innerHTML
        row = row.replaceAll('#ID#', v.id)
          .replace('#CLIENTE#', v.cliente)
          .replace('#DOC#', v.doc)
          .replace('#MONTO#', fmtMoney(v.monto))
          .replace('#ESTADO#', v.estado)
          .replace('#VENDEDOR#', v.vendedor)
        if(role==='gerente'){
          row = row.replace('<button data-action="contrato" data-id="#ID#" class="text-xs btn-primary px-3 py-1 rounded-lg">Contrato</button>', '')
          row = row.replace('<button data-action="borrar" data-id="#ID#" class="text-xs bg-rose-600 text-white px-3 py-1 rounded-lg">Borrar</button>', '')
        }
        return row
      }).join('')
      tbodyVentas.innerHTML = rows || '<tr><td class="p-3 text-slate-500" colspan="7">Sin registros</td></tr>'
      tbodyVentas.querySelectorAll('button').forEach(btn=>{
        const id = Number(btn.dataset.id)
        btn.addEventListener('click', ()=>{
          const action = btn.dataset.action
          if(action==='borrar' && role!=='gerente') delVenta(id)
          if(action==='ver') alert(JSON.stringify(listVentas().find(v=>v.id===id), null, 2))
          if(action==='contrato' && role!=='gerente') genContrato(id)
        })
      })
    }
    filterEstado?.addEventListener('change', renderVentas)
    filterVendedor?.addEventListener('change', renderVentas)

    function delVenta(id){
      const role = session?.rol
      const vs = listVentas()
      const v = vs.find(x=>x.id===id)
      if(!v) return
      if(role==='vendedor' && v.vendedor!==session.user){ return alert('Solo puedes borrar tus propias ventas') }
      saveVentas(vs.filter(x=>x.id!==id))
      renderAll()
    }

    document.getElementById('formVenta')?.addEventListener('submit', e=>{
      e.preventDefault()
      const vs = listVentas()
      const id = (vs.at(-1)?.id ?? 0) + 1
      const data = {
        id,
        cliente: sanitize(document.getElementById('vCliente').value),
        doc: sanitize(document.getElementById('vDoc').value),
        servicio: sanitize(document.getElementById('vServicio').value),
        monto: Number(document.getElementById('vMonto').value||0),
        obs: sanitize(document.getElementById('vObs').value||''),
        estado: 'Registrado',
        vendedor: session.user,
        gestor: '',
        fecha: nowIso(),
        extra: {}
      }
      vs.push(data); saveVentas(vs)
      e.target.reset(); showTab('ventas'); renderAll()
    })

    // ======== GESTIÓN (gestor/admin) ========
    const GESTION_COLS = [
      'MES DE VENTA','GESTOR','SUPERVISOR','EECC','TIPO DE RUC','RUC','RAZON SOCIAL','ANCHO BANDA','TIPO DE SERVICIO','Costo Inc. IGV','ACCESS','FECHA DE INGRESO DE CARPETA','PSI / ID de solicitud','OPP / ID','SAF / ID Carrito','SIRO / ID SERVICIO','ESTADO','PROMOCION','FECHA DE ADMISION / INSTALACION','MES DE ADMISION / INSTALACION','OBSERVACIONES','ASUNTO','CORREO'
    ]
    const theadGestion = document.getElementById('theadGestion')
    const tbodyGestion = document.getElementById('tbodyGestion')
    function monthNameES(d){ const m = new Date(d).toLocaleString('es-PE',{month:'long'}); return m.charAt(0).toUpperCase()+m.slice(1) }
    function ensureExtra(v){ v.extra = v.extra||{}; return v }
    function baseMap(v){ return { 'MES DE VENTA': monthNameES(v.fecha||Date.now()), 'GESTOR': v.gestor||'', 'SUPERVISOR': v.extra?.['SUPERVISOR']||'', 'EECC': v.extra?.['EECC']||'', 'TIPO DE RUC': v.extra?.['TIPO DE RUC']||'', 'RUC': v.doc||'', 'RAZON SOCIAL': v.cliente||'', 'ANCHO BANDA': v.extra?.['ANCHO BANDA']||'', 'TIPO DE SERVICIO': v.servicio||'', 'Costo Inc. IGV': v.monto||'', 'ACCESS': v.extra?.['ACCESS']||'', 'FECHA DE INGRESO DE CARPETA': v.extra?.['FECHA DE INGRESO DE CARPETA']||'', 'PSI / ID de solicitud': v.extra?.['PSI / ID de solicitud']||'', 'OPP / ID': v.extra?.['OPP / ID']||'', 'SAF / ID Carrito': v.extra?.['SAF / ID Carrito']||'', 'SIRO / ID SERVICIO': v.extra?.['SIRO / ID SERVICIO']||'', 'ESTADO': v.estado||'Registrado', 'PROMOCION': v.extra?.['PROMOCION']||'', 'FECHA DE ADMISION / INSTALACION': v.extra?.['FECHA DE ADMISION / INSTALACION']||'', 'MES DE ADMISION / INSTALACION': v.extra?.['MES DE ADMISION / INSTALACION']||'', 'OBSERVACIONES': v.obs||'', 'ASUNTO': v.extra?.['ASUNTO']||'', 'CORREO': v.extra?.['CORREO']||'' } }
    function renderGestion(){
      const role = session?.rol
      const panel = document.getElementById('panel-gestion')
      const show = (role==='gestor'||role==='admin')
      panel.classList.toggle('hidden', !show)
      if(!show) return
      theadGestion.innerHTML = '<tr>'+ GESTION_COLS.map(c=>`<th class="text-left p-2 th">${c}</th>`).join('') + '<th class="p-2 th">Acciones</th></tr>'
      const rows = listVentas().map(v=>{
        v = ensureExtra(v)
        const map = baseMap(v)
        const tds = GESTION_COLS.map(col=>{
          const readOnlyCols = ['MES DE VENTA','OPP / ID','MES DE ADMISION / INSTALACION']
          if(col==='ESTADO'){
            const opts = ['Registrado','En revisión','Aprobado','Rechazado','Contrato generado']
            const options = opts.map(o=>`<option ${o===map[col]?'selected':''}>${o}</option>`).join('')
            return `<td class="p-1"><select data-col="${col}" data-id="${v.id}" class="border rounded-lg px-2 py-1 text-[12px]">${options}</select></td>`
          }
          const isDate = ['FECHA DE INGRESO DE CARPETA','FECHA DE ADMISION / INSTALACION'].includes(col)
          const type = isDate ? 'date' : (col==='Costo Inc. IGV' ? 'number' : 'text')
          const step = col==='Costo Inc. IGV' ? ' step="0.01"' : ''
          const val = isDate && map[col] ? new Date(map[col]).toISOString().slice(0,10) : map[col]
          const ro = readOnlyCols.includes(col) ? 'readonly' : ''
          return `<td class="p-1"><input ${ro} data-col="${col}" data-id="${v.id}" type="${type}"${step} value="${val}" class="border rounded-lg px-2 py-1 text-[12px] w-44"/></td>`
        }).join('')
        return `<tr class="border-b">${tds}<td class="p-1"><button data-action="guardarFila" data-id="${v.id}" class="text-xs btn-sec px-3 py-1 rounded-lg">Guardar</button></td></tr>`
      }).join('')
      tbodyGestion.innerHTML = rows || '<tr><td class="p-3 text-slate-500" colspan="999">Sin registros</td></tr>'
      tbodyGestion.querySelectorAll('button[data-action="guardarFila"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = Number(btn.dataset.id)
          const vs = listVentas(); const v = ensureExtra(vs.find(x=>x.id===id)); if(!v) return
          GESTION_COLS.forEach(col=>{
            const el = tbodyGestion.querySelector(`[data-col="${col}"][data-id="${id}"]`)
            if(!el) return
            const raw = (el.type==='number') ? Number(el.value||0) : el.value
            const val = (typeof raw==="string") ? sanitize(raw) : raw
            if(col==='MES DE VENTA') return
            if(col==='GESTOR'){ v.gestor = val; return }
            if(col==='ESTADO'){ v.estado = el.value; return }
            if(col==='RAZON SOCIAL'){ v.cliente = val; return }
            if(col==='RUC'){ v.doc = val; return }
            if(col==='TIPO DE SERVICIO'){ v.servicio = val; return }
            if(col==='Costo Inc. IGV'){ v.monto = Number(raw)||0; return }
            if(col==='OBSERVACIONES'){ v.obs = val; return }
            if(col==='FECHA DE ADMISION / INSTALACION'){
              v.extra[col] = el.value
              const m = new Date(el.value||Date.now()).toLocaleString('es-PE',{month:'long'})
              v.extra['MES DE ADMISION / INSTALACION'] = m.charAt(0).toUpperCase()+m.slice(1)
              return
            }
            v.extra[col] = (el.type==='number') ? Number(el.value||0) : val
          })
          saveVentas(vs); renderAll()
        })
      })
    }

    // ======== USUARIOS (ADMIN) ========
    const tbodyUsers = document.getElementById('tbodyUsers')
    function listUsers(){ return LS.get('users', []) }
    function saveUsers(u){ LS.set('users', u) }
    document.getElementById('formUser')?.addEventListener('submit', e=>{ e.preventDefault(); const u = sanitize(document.getElementById('uUser').value); const p = document.getElementById('uPass').value; const r = document.getElementById('uRol').value; const users = listUsers(); if(users.some(x=>x.user===u)) return alert('Usuario ya existe'); users.push({user:u, pass:p, rol:r}); saveUsers(users); e.target.reset(); renderUsers() })
    function renderUsers(){ const role = session?.rol; const panel = document.getElementById('panel-usuarios'); panel.classList.toggle('hidden', role!=='admin'); if(role!=='admin') return; const rows = listUsers().map(u=>{ let row = document.getElementById('tplUserRow').innerHTML; row = row.replaceAll('#USER#', u.user).replace('#ROL#', u.rol); return row }).join(''); tbodyUsers.innerHTML = rows || '<tr><td class="p-3 text-slate-500" colspan="3">Sin usuarios</td></tr>'; tbodyUsers.querySelectorAll('.btnDelUser').forEach(btn=>{ btn.addEventListener('click', ()=>{ const u = btn.dataset.user; const users = listUsers().filter(x=>x.user!==u); saveUsers(users); renderUsers() }) }) }

    // ======== REPORTE (gerente/admin) ========
    function renderReporte(){ const role = session?.rol; const panel = document.getElementById('panel-reporte'); const show = (role==='gerente'||role==='admin'); panel.classList.toggle('hidden', !show); if(!show) return; const ventas = listVentas(); const totalVentas = ventas.length; const totalMonto = ventas.reduce((a,b)=> a + Number(b.monto||0), 0); const porEstado = ventas.reduce((acc,v)=>{ acc[v.estado]= (acc[v.estado]||{n:0, m:0}); acc[v.estado].n++; acc[v.estado].m += Number(v.monto||0); return acc }, {}); const contratos = porEstado['Contrato generado']?.n||0; const conv = totalVentas? Math.round((contratos/totalVentas)*100) : 0; document.getElementById('kpiMonto').textContent = totalMonto.toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2}); document.getElementById('kpiVentas').textContent = totalVentas; document.getElementById('kpiConv').textContent = conv; document.getElementById('barConv').style.width = conv + '%'; const tbody = document.getElementById('tbodyResumen'); const estados = ['Registrado','En revisión','Aprobado','Rechazado','Contrato generado']; tbody.innerHTML = estados.map(e=>{ const r = porEstado[e]||{n:0,m:0}; return `<tr class="border-b"><td class="p-2">${e}</td><td class="p-2">${r.n}</td><td class="p-2">${r.m.toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2})}</td></tr>` }).join('') }

    // ======== DASHBOARD (gerente/admin) ========
    function renderDashboard(){ const role = session?.rol; const panel = document.getElementById('panel-dashboard'); const show = (role==='gerente'||role==='admin'); panel.classList.toggle('hidden', !show); if(!show) return; const ventas = listVentas(); const totalMonto = ventas.reduce((a,b)=> a + Number(b.monto||0), 0); const ticket = ventas.length? totalMonto/ventas.length : 0; const count = (estado)=> ventas.filter(v=>v.estado===estado).length; document.getElementById('kpiTicket').textContent = ticket.toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2}); document.getElementById('kpiAprobadas').textContent = count('Aprobado'); document.getElementById('kpiRevision').textContent = count('En revisión'); document.getElementById('kpiRechazadas').textContent = count('Rechazado'); const byMonth = {}; ventas.forEach(v=>{ const d = new Date(v.fecha||Date.now()); const k = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); byMonth[k] = (byMonth[k]||0) + Number(v.monto||0) }); const monthKeys = Object.keys(byMonth).sort(); const monthLabels = monthKeys.map(k=>{ const [y,m]=k.split('-'); const d=new Date(Number(y),Number(m)-1,1); return d.toLocaleString('es-PE',{month:'short'})+' '+y.slice(-2) }); const monthVals = monthKeys.map(k=>byMonth[k]); const estados = ['Registrado','En revisión','Aprobado','Rechazado','Contrato generado']; const byEstado = estados.map(e=> ventas.filter(v=>v.estado===e).reduce((a,b)=>a+Number(b.monto||0),0)); function svgBars(labels, values){ const max = Math.max(1, ...values); const width = Math.max(360, labels.length*70); const height = 200; const barW = Math.floor((width-40)/labels.length) - 20; let x = 30; let bars = ''; labels.forEach((label, i)=>{ const val = values[i]; const h = Math.round((val/max)*(height-60)); const y = height-30 - h; bars += `<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="6" fill="#00A7E1"></rect>`; bars += `<text x="${x+barW/2}" y="${height-10}" font-size="10" text-anchor="middle" fill="#334155">${label}</text>`; bars += `<title>S/. ${val.toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2})}</title>`; x += barW + 20 }); return `<svg viewBox="0 0 ${width} ${height}" class="min-w-full">${bars}</svg>` } document.getElementById('chartMeses').innerHTML = svgBars(monthLabels, monthVals); document.getElementById('chartEstados').innerHTML = svgBars(estados, byEstado) }

    // ======== CONTRATO (PDF) ========
    async function genContrato(id){ const v = listVentas().find(x=>x.id===id); if(!v) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const today = new Date(); doc.setFontSize(16); doc.text('CONTRATO DE SERVICIO – DEMO', 20, 20); doc.setFontSize(11); doc.text(`Fecha: ${today.toLocaleDateString('es-PE')}`, 20, 30); doc.text(`Cliente: ${v.cliente}`, 20, 40); doc.text(`Documento: ${v.doc}`, 20, 48); doc.text(`Servicio: ${v.servicio}`, 20, 56); doc.text(`Monto: S/. ${fmtMoney(v.monto)}`, 20, 64); doc.text(`Vendedor: ${v.vendedor}`, 20, 72); doc.text('Este documento es un DEMO generado en el navegador.', 20, 88); doc.save(`CONTRATO_${String(v.id).padStart(4,'0')}.pdf`); const vs = listVentas(); const idx = vs.findIndex(x=>x.id===id); if(idx>=0){ vs[idx].estado = 'Contrato generado'; saveVentas(vs); renderAll() } }

    // ======== EXPORT/IMPORT JSON ========
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const payload = { users: LS.get('users', []), ventas: listVentas() }
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'})
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'crm_data.json'; a.click()
    })
    document.getElementById('inputImport').addEventListener('change', e=>{
      const file = e.target.files?.[0]; if(!file) return
      const reader = new FileReader()
      reader.onload = () => {
        try{ const data = JSON.parse(reader.result)
          if(Array.isArray(data.users)) LS.set('users', data.users)
          if(Array.isArray(data.ventas)) LS.set('ventas', data.ventas)
          renderAll()
        }catch{ alert('JSON inválido') }
      }
      reader.readAsText(file)
      e.target.value = ''
    })

    // ======== EXPORTAR XLSX (CABECERAS FILA 1) ========
    function ventasToRowsForXLSX(ventas){
      return ventas.map(v=>{
        const ex = v.extra||{}
        const base = {
          'MES DE VENTA': ex['MES DE VENTA'] || (new Date(v.fecha||Date.now()).toLocaleString('es-PE',{month:'long'})),
          'GESTOR': v.gestor||'',
          'SUPERVISOR': ex['SUPERVISOR']||'',
          'EECC': ex['EECC']||'',
          'TIPO DE RUC': ex['TIPO DE RUC']||'',
          'RUC': v.doc||'',
          'RAZON SOCIAL': v.cliente||'',
          'ANCHO BANDA': ex['ANCHO BANDA']||'',
          'TIPO DE SERVICIO': v.servicio||'',
          'Costo Inc. IGV': v.monto||'',
          'ACCESS': ex['ACCESS']||'',
          'FECHA DE INGRESO DE CARPETA': ex['FECHA DE INGRESO DE CARPETA']||'',
          'PSI / ID de solicitud': ex['PSI / ID de solicitud']||'',
          'OPP / ID': ex['OPP / ID']||'',
          'SAF / ID Carrito': ex['SAF / ID Carrito']||'',
          'SIRO / ID SERVICIO': ex['SIRO / ID SERVICIO']||'',
          'ESTADO': v.estado||'',
          'PROMOCION': ex['PROMOCION']||'',
          'FECHA DE ADMISION / INSTALACION': ex['FECHA DE ADMISION / INSTALACION']||'',
          'MES DE ADMISION / INSTALACION': ex['MES DE ADMISION / INSTALACION']||'',
          'OBSERVACIONES': v.obs||'',
          'ASUNTO': ex['ASUNTO']||'',
          'CORREO': ex['CORREO']||''
        }
        return base
      })
    }

    function exportXLSX(){
      const base = listVentas()
      const data = applyFilters(base)
      if(!data.length){ alert('No hay registros para exportar'); return }
      const rows = ventasToRowsForXLSX(data)
      const ws = XLSX.utils.json_to_sheet(rows, {header: GESTION_COLS})
      const colWidths = GESTION_COLS.map(h=>({wch: Math.max(12, String(h).length+2)}))
      ws['!cols'] = colWidths
      const wb = XLSX.utils.book_new()
      XLSX.utils.book_append_sheet(wb, ws, 'Ventas')
      XLSX.writeFile(wb, 'netcom_ventas.xlsx')
    }
    btnExportXLSX?.addEventListener('click', exportXLSX)

    // ======== RENDER ALL ========
    function renderAll(){ renderVentas(); renderGestion(); renderUsers(); renderReporte(); renderDashboard(); }

    // init
    enter()
  </script>
</body>
</html>
